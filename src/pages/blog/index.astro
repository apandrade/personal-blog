---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { db } from '../../lib/data';
import { changeLanguage, t } from 'i18next';

// Switch to Portuguese
await changeLanguage('pt');

const currentLocale = Astro.currentLocale || 'pt';

// Fetch ALL posts for client-side filtering
const paginatedResult = await db.getPosts({ perPage: 999 });
const availableDates = await db.getAvailableDates();

const allPosts = paginatedResult.posts;
---

<BaseLayout 
  title={t('blog.title')} 
  description="Browse all blog posts"
>
  <div class="blog-page">
    <div class="container">
      <h1 class="page-title">{t('blog.title')}</h1>

      <div class="blog-controls">
        <div class="filters">
          <div class="search-bar">
            <input
              type="text"
              id="search-input"
              placeholder={t('common.search')}
              class="search-input"
            />
          </div>
          
          <div class="date-filter">
            <select id="year-filter" class="filter-select">
              <option value="">{t('common.allPosts')}</option>
              {Array.from(new Set(allPosts.map(p => p.publishedAt.getFullYear()))).sort((a, b) => b - a).map(year => (
                <option value={year}>{year}</option>
              ))}
            </select>
          </div>
        </div>

        <div class="actions">
          <button id="sort-toggle" class="sort-button" data-order="desc" title="Sort order">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path id="sort-icon" d="M3 6h18M3 12h12M3 18h6"></path>
            </svg>
          </button>
          
          <div class="view-toggle">
            <button class="view-button active" data-view="grid">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
            </button>
            <button class="view-button" data-view="list">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div id="posts-container" class="posts-container view-grid">
        <!-- Posts will be rendered here by JS -->
      </div>
      
      <div id="load-more-container" class="load-more" style="display: none;">
        <button id="load-more-btn" class="load-more-button">Load More Posts</button>
        <p id="posts-count" class="posts-info"></p>
      </div>
      
      <div id="no-posts" class="no-posts" style="display: none;">
        <p>{t('blog.noPosts')}</p>
      </div>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ allPosts, currentLocale }}>
  // Global state
  let filteredPosts = [...allPosts];
  let displayedCount = 10;
  const postsPerPage = 10;
  let currentView = 'grid';
  let currentSort = 'desc';
  
  // Format date
  function formatDate(date, locale) {
    return new Date(date).toLocaleDateString(locale === 'pt' ? 'pt-BR' : 'en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }
  
  // Render posts
  function renderPosts() {
    const container = document.getElementById('posts-container');
    const loadMoreContainer = document.getElementById('load-more-container');
    const loadMoreBtn = document.getElementById('load-more-btn');
    const postsCount = document.getElementById('posts-count');
    const noPosts = document.getElementById('no-posts');
    
    if (filteredPosts.length === 0) {
      container.innerHTML = '';
      loadMoreContainer.style.display = 'none';
      noPosts.style.display = 'block';
      return;
    }
    
    noPosts.style.display = 'none';
    const postsToShow = filteredPosts.slice(0, displayedCount);
    
    container.innerHTML = postsToShow.map(post => `
      <article class="post-card">
        <a href="/blog/${post.slug}" class="post-link">
          <img src="${post.coverImage}" alt="${post.title}" class="post-image" loading="lazy" />
          <div class="post-content">
            <h3 class="post-title">${post.title}</h3>
            <p class="post-excerpt">${post.excerpt}</p>
            <time class="post-date">${formatDate(post.publishedAt, currentLocale)}</time>
          </div>
        </a>
      </article>
    `).join('');
    
    // Show/hide load more button
    if (displayedCount < filteredPosts.length) {
      loadMoreContainer.style.display = 'flex';
      postsCount.textContent = `Showing ${displayedCount} of ${filteredPosts.length} posts`;
    } else {
      loadMoreContainer.style.display = 'none';
    }
  }
  
  // Filter posts
  function filterPosts() {
    const searchValue = document.getElementById('search-input').value.toLowerCase();
    const yearValue = document.getElementById('year-filter').value;
    
    filteredPosts = allPosts.filter(post => {
      const matchesSearch = !searchValue || 
        post.title.toLowerCase().includes(searchValue) ||
        post.excerpt.toLowerCase().includes(searchValue);
      
      const matchesYear = !yearValue || 
        new Date(post.publishedAt).getFullYear() === parseInt(yearValue);
      
      return matchesSearch && matchesYear;
    });
    
    // Sort posts
    filteredPosts.sort((a, b) => {
      const dateA = new Date(a.publishedAt).getTime();
      const dateB = new Date(b.publishedAt).getTime();
      return currentSort === 'desc' ? dateB - dateA : dateA - dateB;
    });
    
    displayedCount = postsPerPage;
    renderPosts();
  }
  
  // Event listeners
  document.getElementById('search-input').addEventListener('input', filterPosts);
  document.getElementById('year-filter').addEventListener('change', filterPosts);
  
  document.getElementById('load-more-btn').addEventListener('click', () => {
    displayedCount += postsPerPage;
    renderPosts();
  });
  
  document.getElementById('sort-toggle').addEventListener('click', () => {
    currentSort = currentSort === 'desc' ? 'asc' : 'desc';
    filterPosts();
  });
  
  document.querySelectorAll('.view-button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.view-button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentView = btn.dataset.view;
      document.getElementById('posts-container').className = `posts-container view-${currentView}`;
    });
  });
  
  // Initial render
  filterPosts();
</script>

<style>
  .blog-page {
    padding: 3rem 0;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  .page-title {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 3rem;
    color: #000;
  }

  .blog-controls {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .filters {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .no-posts {
    text-align: center;
    padding: 4rem 2rem;
    color: #666;
    font-size: 1.125rem;
  }

  /* Search bar */
  .search-bar {
    margin-bottom: 1rem;
  }

  .search-input {
    width: 100%;
    max-width: 500px;
    padding: 0.75rem 1rem;
    border: 1px solid #e6e6e6;
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  .search-input:focus {
    outline: none;
    border-color: #000;
  }

  /* Date filter */
  .date-filter {
    margin-bottom: 1rem;
  }

  .filter-select {
    padding: 0.75rem 1rem;
    border: 1px solid #e6e6e6;
    border-radius: 4px;
    font-size: 1rem;
    background: #fff;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .filter-select:focus {
    outline: none;
    border-color: #000;
  }

  /* Sort button */
  .sort-button {
    padding: 0.75rem 1rem;
    background: #f5f5f5;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sort-button:hover {
    background: #e0e0e0;
  }

  /* View toggle */
  .view-toggle {
    display: flex;
    gap: 0.25rem;
    background: #f5f5f5;
    padding: 0.25rem;
    border-radius: 4px;
  }

  .view-button {
    padding: 0.5rem;
    background: transparent;
    border: none;
    cursor: pointer;
    border-radius: 3px;
    color: #666;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .view-button:hover {
    background: #e0e0e0;
    color: #000;
  }

  .view-button.active {
    background: #fff;
    color: #000;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  /* Posts container */
  .posts-container {
    display: grid;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .view-grid {
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  }

  .view-list {
    grid-template-columns: 1fr;
  }

  /* Post card */
  .post-card {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid #e6e6e6;
  }

  .post-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .post-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .post-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .post-content {
    padding: 1.5rem;
  }

  .post-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.75rem 0;
    color: #000;
    line-height: 1.3;
  }

  .post-excerpt {
    color: #666;
    margin: 0 0 1rem 0;
    line-height: 1.6;
  }

  .post-date {
    font-size: 0.875rem;
    color: #999;
  }

  /* Load more */
  .load-more {
    margin-top: 3rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .load-more-button {
    padding: 1rem 2rem;
    background: #000;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .load-more-button:hover {
    opacity: 0.8;
  }

  .posts-info {
    color: #666;
    font-size: 0.875rem;
  }

  @media (max-width: 768px) {
    .page-title {
      font-size: 2rem;
    }

    .actions {
      flex-direction: column;
      align-items: stretch;
    }
    
    .posts-container {
      grid-template-columns: 1fr;
    }
  }
</style>
